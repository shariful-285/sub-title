console.log("Background service worker started.");chrome.runtime.onMessage.addListener((i,n,m)=>{var p;return i.type==="AUDIO_CHUNK"&&P(i.payload,(p=n.tab)==null?void 0:p.id),!0});async function P(i,n){var m,p,h,f,w,b,y,x,T;try{console.log("Processing audio chunk for direct API transcription...");const t=(await chrome.storage.local.get(["extension_config"])).extension_config;if(!t||!t.apiKey)throw new Error("API Key missing. Please set it in Subtitle Settings.");const R=await(await fetch(i.data)).blob(),v=new File([R],"audio.webm",{type:"audio/webm"});let s="",d="";const r={};t.provider==="groq"?(s="https://api.groq.com/openai/v1/audio/transcriptions",d="whisper-large-v3"):t.provider==="openrouter"?(s="https://openrouter.ai/api/v1/chat/completions",d="google/gemma-3n-4b:free",r["HTTP-Referer"]="https://github.com/subtitle-gen-ext",r["X-Title"]="YouTube Subtitle Generator",r["Content-Type"]="application/json"):t.provider==="gemini"?(s=`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${t.apiKey}`,r["Content-Type"]="application/json"):(s="https://api.openai.com/v1/audio/transcriptions",d="whisper-1");let c;if(t.provider==="gemini"){const o=i.data.split(",")[1],e=await fetch(s,{method:"POST",headers:r,body:JSON.stringify({contents:[{parts:[{text:"Transcribe this audio exactly. Output only the transcription text."},{inline_data:{mime_type:"audio/webm",data:o}}]}]})});if(!e.ok){if(e.status===429)throw new Error("Rate limit reached (Gemini Free Tier). Please wait a moment for the next subtitle.");const a=await e.text();throw new Error(`Gemini Error ${e.status}: ${a}`)}c={text:((w=(f=(h=(p=(m=(await e.json()).candidates)==null?void 0:m[0])==null?void 0:p.content)==null?void 0:h.parts)==null?void 0:f[0])==null?void 0:w.text)||"",segments:[]}}else if(t.provider==="openrouter"){const o=i.data.split(",")[1],e=await fetch(s,{method:"POST",headers:{...r,Authorization:`Bearer ${t.apiKey}`},body:JSON.stringify({model:d,messages:[{role:"user",content:[{type:"text",text:"Transcribe this audio exactly."},{type:"input_audio",input_audio:{data:o,format:"webm"}}]}]})});if(!e.ok){const a=await e.text();throw new Error(`OpenRouter Error ${e.status}: ${a}`)}c={text:((x=(y=(b=(await e.json()).choices)==null?void 0:b[0])==null?void 0:y.message)==null?void 0:x.content)||"",segments:[]}}else{const o=new FormData;o.append("file",v),o.append("model",d),o.append("response_format","verbose_json"),o.append("timestamp_granularities[]","segment"),r.Authorization=`Bearer ${t.apiKey}`;const e=await fetch(s,{method:"POST",headers:r,body:o});if(!e.ok){if(e.status===429)throw new Error("Rate limit reached (Free Tier). Please wait a moment for the next subtitle.");const l=await e.text().catch(()=>"No error body");let a=`API Error ${e.status}: ${e.statusText}`;try{const g=JSON.parse(l);a=((T=g.error)==null?void 0:T.message)||g.message||a}catch{l.length>0&&(a+=` - ${l.substring(0,100)}`)}throw new Error(a)}c=await e.json()}console.log("Transcription received:",c),n&&chrome.tabs.sendMessage(n,{type:"TRANSCRIPT_RESULT",payload:{text:c.text,start:i.timestamp,segments:c.segments||[]}})}catch(u){console.error("Error handling audio chunk:",u),n&&chrome.tabs.sendMessage(n,{type:"TRANSCRIPT_ERROR",payload:{error:u.message||"Failed to transcribe audio"}})}}
